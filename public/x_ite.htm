<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="https://code.create3000.de/x_ite/4.6.8/dist/x_ite.css"/>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="https://code.create3000.de/x_ite/4.6.8/dist/x_ite.min.js"></script>
    <script type="text/javascript">
        (async function() {
            window.addEventListener("hashchange", function(e) {
                location.reload();
            });
            const [worldID, subroom] = location.hash.substr(1).split("|");
            const worldData = await fetch("/data/worlds.json").then(resp => resp.json()).then(worlds => worlds[worldID]);
            const worldURL = worldData.url;
            const room = worldData.room + (subroom ? "|" + subroom : "");
            X3D(function() {
                let browser = X3D.createBrowser();
                browser.setAttribute("src", worldURL);
                document.querySelector("#world").appendChild(browser);
                BxxEvents.dispatchEvent(new CustomEvent("INIT"));
                X3D.getBrowser().addBrowserCallback({}, function(eventType) {
                    if(eventType === X3D.X3DConstants.INITIALIZED_EVENT) {
                        let { x: pos_x, y: pos_y, z: pos_z } = X3D.getBrowser().viewpointPosition;
                        let { x: rot_x, y: rot_y, z: rot_z, angle: rot_angle } = X3D.getBrowser().viewpointOrientation;
                        BxxEvents.dispatchEvent(new CustomEvent("INIT:network", {
                            detail: {
                                room: room,
                                avatar: localStorage.getItem("avatar") || "default",
                                pos: {x: pos_x, y: pos_y, z: pos_z},
                                rot: {x: rot_x, y: rot_y, z: rot_z, angle: rot_angle}
                            }
                        }));
                    }
                });
            });
        })();
    </script>
    <script type="text/javascript" src="/xite_js/xite_bxx.js"></script>
    <!--<script type="text/javascript" src="/xite_js/xite_so.js"></script>-->
    <script type="text/javascript" src="/xite_js/xite_se.js"></script>
    <script type="text/javascript" src="/xite_js/xite_av.js"></script>
    <script type="text/javascript" src="/xite_js/xite_socketio.js"></script>

    <style type="text/css">
    html, body {
        height: 100%;
    }
    body {
        margin: 0;
    }

X3DCanvas, .world {
  height: 100%;
  width: 100%;
  scroll: none;
}
    </style>
  </head>
  <body>
    <div class="world" id="world">
    </div>
  </body>
</html>